name: Stock News Bot

on:
  schedule:
    # Lịch 1: Chạy mỗi 15 phút, từ 7:00 sáng đến 10:45 tối VN (0:00 - 15:45 UTC)
    - cron: '*/15 0-15 * * *'
    
    # Lịch 2: Chạy lúc 6:30 sáng VN (23:30 UTC)
    - cron: '30 23 * * *' 
  
  workflow_dispatch:

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. TẢI CACHE (RESTORE): Đọc file sent_links.txt cũ
      - name: Restore Sent Links Cache
        id: cache-restore 
        uses: actions/cache@v3
        with:
          path: sent_links.txt
          # Sử dụng hash của main.py làm key để nếu bạn thay đổi main.py, cache sẽ được làm mới
          key: ${{ runner.os }}-sent-links-${{ hashFiles('main.py') }} 

      # 2. Checkout code (Giữ nguyên)
      - name: Checkout code
        uses: actions/checkout@v3

      # 3. Setup Python (Giữ nguyên)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 4. Cài đặt dependencies (Giữ nguyên)
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 5. CHẠY BOT (File sent_links.txt được cập nhật)
      - name: Run Bot
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python main.py
        
      # 6. LƯU CACHE (SAVE): LƯU file sent_links.txt mới
      # BƯỚC NÀY KHẮC PHỤC HOÀN TOÀN LỖI LẶP TIN
      - name: Save Sent Links Cache
        uses: actions/cache@v3
        # if: always() đảm bảo bước này chạy kể cả khi bot không tìm thấy tin mới (để lưu cache)
        if: always() 
        with:
          path: sent_links.txt
          key: ${{ runner.os }}-sent-links-${{ hashFiles('main.py') }}
